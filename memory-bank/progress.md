## Progress

### What works
- Project website [ai-antispam.ru](https://ai-antispam.ru)
- Telegram webhook server
- aiogram handlers
- Spam classifier (LLM + Context + Stories + Account Age + Discussion Context with relevance evaluation)
- **AI & Emoji Detection**: ✅ **Complete** - Expanded prompt guidance to detect robotic AI tone, generic summaries, and unusual emoji usage. Filters low-value content regardless of conversion tactic (stories/linked channels).
- Billing via Telegram Stars
- **Prompt Optimization & Cleanup**: ✅ **Complete** - Refined system prompt with guidance for User Name analysis, Knowledge Sharing bait, and Value-Add philosophy. Audited and cleaned few-shot examples database, stripping AI-generated reasons and notification wrappers.
- PostgreSQL data layer
- MTProto bridge
- Telegram logging handler
- **Robust Permission Handling**:
  - Message deletion permission checks.
  - **User ban permission checks** (New: notifies admins if ban fails).
- Admin Notifications:
  - Private chat priority
  - Group chat fallback
  - Automatic cleanup if unreachable
  - **Collapsed Quote Formatting**: Both cited message and reason now display as collapsed blockquotes for better readability
- **Broadcast updates script**: `scripts/broadcast_updates.py` can push multi-line status notes to every admin, reports unreachable IDs, and logs delivery details while deactivating unreachable admins to reduce repeated failures.
- **Bot block handling**: Receiving a private chat update that the bot was blocked now deactivates that admin so the system stops targeting unreachable contacts. **Total User Time Tracking**: When a user blocks the bot, the system calculates and logs the total time they were with the bot (from account creation to blocking) in days as a span attribute for analytics. **Root Span Enrichment**: Message processing spans now include comprehensive LLM response details (score, confidence, reason) and collected user context (bio, name, linked channel info, stories, account age, reply context) as attributes for enhanced observability and analytics.
- Linked Channel detection (Username-first resolution)
- **Enhanced Channel Content Analysis**: ✅ **Tested & Working** - Now fetches and analyzes text content from recent posts, not just metadata (successfully detects porn/spam channels by content)
- **Spam Example Curation**: ✅ **Database Optimized** - Promoted 15 high-quality patterns to common, deduplicated 14 redundant entries from the baseline, and cleaned up top 2 admins. Baseline now provides high-quality starting point with balanced scores.
- **Testing Infrastructure**: ✅ **Complete** - Proper separation of unit tests (93) from integration tests. pytest.ini addopts correctly excludes integration tests from deployment. All integration tests properly marked with `@pytest.mark.integration`.
- **Documentation**: ✅ **Updated PRD** - `PRD.md` synchronized with codebase and memory bank. ✅ **Spam Tactics File** - Created `memory-bank/spamTactics.md` to track evolving spam patterns and examples, supported by a new Cursor rule.
- **MTProto Optimization**: ✅ **Peer Resolution Optimized** - Eliminated 90%+ failing numeric ID calls by requiring username-only resolution.
- **Logfire Message Lookup**: ✅ **Improved** - Added support for recovering edited messages and implemented robust text matching using `LIKE` patterns that bypass hidden characters (e.g., zero-width spaces/word joiners).
- Hidden User ID Recovery
- **Edited Message Handling**: ✅ **Added Handler for Edited Messages** - Edited messages now return "edited_message_ignored" tag instead of generic "unhandled" for better Logfire observability. Handler does nothing else - edited messages are not moderated.
    - **Landing Page**: ✅ **Complete** - Professional Russian landing page with Tailwind CSS, real spam examples, FAQ, strong CTA, optimized styling, improved accessibility, and automated CI/CD deployment to GitHub Pages. Explicitly emphasizes Telegram spam protection.
- **Handler Return Values**: ✅ **Fixed** - All Telegram update handlers now return descriptive strings instead of None, preventing "_ignored" tags in logfire traces. Fixed payment handlers (`handle_buy_command`, `handle_buy_stars_callback`, `process_pre_checkout_query`, `process_successful_payment`) and command handlers (`cmd_ref`).
- **Logfire Instrumentation Pattern**: ✅ **Complete** - Implemented approved system pattern: auto-tracing for modules (`app.database`, `app.handlers`, `app.spam`) with `@logfire.no_auto_trace` decorators on manually instrumented functions to prevent span duplication while maintaining granular monitoring.
- **Enhanced Spam Examples Context Storage**: ✅ **Complete** - Added `stories_context`, `reply_context`, `account_age_context` fields to spam examples database with three-state differentiation (NULL for historical, '[EMPTY]' for checked-but-empty, content for found). Logfire trace recovery enables context extraction from forwarded messages. Examples now include full classification context for improved LLM training effectiveness.
- **LLM Model Evaluation Infrastructure**: ✅ **Complete** - Comprehensive evaluation script (`scripts/eval_llm_models.py`) with balanced test cases, hierarchical tqdm progress bars, JSON results storage, model isolation, and detailed accuracy metrics (precision, recall, F1). Includes automatic result persistence to `eval_results/` directory and git exclusion.
- **Cloudflare AI Gateway Integration**: ✅ **Complete** - Migrated all LLM operations from OpenRouter to Cloudflare AI Gateway. Added `get_cloudflare_response()` function, updated spam classifier and private handlers, fixed environment configuration, and cleaned up provider-specific documentation. All calls now route through Cloudflare with OpenRouter preserved as fallback.
- **LLM Provider Resilience**: ✅ **Complete** - Implemented strategic retry allocation: Cloudflare (1 fast attempt) → OpenRouter (3 attempts with full retry logic). Cloudflare fails quickly to minimize latency, OpenRouter provides robust fallback with model rotation and rate limit handling.
- **Code Architecture & Quality**: ✅ **Complete** - Comprehensive module reorganization moving spam detection logic to dedicated `src/app/spam/` directory. Implemented robust context collection architecture with `ContextResult` wrapper and clear status contracts. **Message Handler Modularization**: ✅ **Complete** - Split monolithic message_handlers.py (807 lines) into focused modules: `handlers/message/pipeline.py`, `handlers/message/validation.py`, `handlers/message/channel_management.py`, and `spam/message_context.py`. Achieved 38-line main handler with clean separation of concerns and improved maintainability. Achieved significant code quality improvements with systematic linting cleanup (74→57 errors), ruff linting compliance, and all tests passing. **MTProto Peer Context Establishment**: ✅ **Documented** - Comprehensive documentation of the peer resolution preparation process with clear strategies for different message types. **Sender Metadata Flow Refactoring**: ✅ **Complete** - Consolidated sender metadata extraction (name, bio) into `route_sender_context_collection` function, eliminating the confusing split between context collection and metadata extraction. Improved code clarity and logical separation of concerns.
- **HTML Hyperlink Preservation**: ✅ **Fixed** - Private chat LLM responses now preserve hyperlinks instead of stripping them, improving user experience with clickable links in bot responses.
- **Enhanced Story Context Collection**: ✅ **Complete** - Stories with media-only content (like channel invite links) are now included in LLM prompts instead of being skipped. Previously, stories without captions or text entities were ignored, but now the system extracts links from `messageMediaWebPage`, `media_areas` (clickable URL areas on videos/images), and other media types, ensuring comprehensive context for spam detection.
- **Advanced Context Collection**: ✅ **Complete** - On-demand user bot subscription system enables comprehensive spam detection for all users, regardless of username availability. Unified subscription logic with DRY helpers, simplified MTProto calls, and merged utility modules for clean architecture. **Optimized Discussion Thread Context**: ✅ **Complete** - Smart peer resolution that skips subscription for discussion threads (may be private) and uses thread-based reading only via `messages.getReplies` for maximum efficiency. **Forum vs Discussion Distinction**: ✅ **Complete** - Correctly distinguishes between forum topic messages (`is_topic_message: true`) and discussion thread messages using the Telegram Bot API `is_topic_message` field. **Universal Message Object Optimization**: ✅ **Complete** - All context collection functions now accept either full message objects or individual parameters, eliminating redundant field extraction and maintaining backward compatibility across different calling contexts (message processing, callbacks, forwarded messages). **Channel-Linked Discussion Thread Resolution**: ✅ **Complete** - Enhanced peer resolution for discussion groups linked to channels now reads from the **public channel** instead of potentially private discussion groups, using original channel post IDs extracted from forwarded messages (`forward_from_message_id`) for optimal MTProto peer resolution. **Membership Pre-check Optimization**: ✅ **Complete** - Implemented ~92% performance improvement for group subscription by adding fast membership pre-check via `messages.getHistory` before attempting expensive `channels.joinChannel` calls. Uses Option 2B error classification to distinguish permanent vs transient errors, with comprehensive logging for monitoring.
- **Dependency Optimization**: ✅ **Complete** - Removed `bs4` (BeautifulSoup) dependency from the project. Refactored `sanitize_llm_html()` in `utils.py` to use a lightweight regex-based approach for sanitizing LLM-generated HTML, reducing overhead and removing an unused external dependency.
- **HTML Tag Compliance**: ✅ **Complete** - Updated `sanitize_llm_html()` to exactly match official Telegram Bot API HTML formatting specifications from core.telegram.org/bots/api#html-style. Added missing `<blockquote>` and `<tg-emoji>` tags. Now supports all officially documented HTML tags: `<b>`, `<strong>`, `<i>`, `<em>`, `<u>`, `<ins>`, `<s>`, `<strike>`, `<del>`, `<tg-spoiler>`, `<span class="tg-spoiler">`, `<a>`, `<code>`, `<pre>`, `<blockquote>`, `<tg-emoji>`.
- **MTProto Spam Notifications**: ✅ **Complete** - Implemented MTProto-based promotional notifications sent to human spammers with linked channels and administrators of spamming channels when spam is blocked and channels are discovered. Fixed MCP tool call validation (chat_id as string, lowercase parse_mode) for reliable delivery. Restructured data flow to include channel user lists directly in `LinkedChannelSummary` dataclass for cleaner architecture. Uses existing `channels.getFullChannel` API responses to extract human admin lists from spamming channels without additional calls. Notifications include bot website and channel links to increase reach among active channel promoters.
- **Linked Channel Sources & Display**: ✅ **Complete** - Linked channel collection preference: profile linked > first mention in bio > first mention in message. `extract_first_channel_mention()` in `spam/linked_channel_mention.py`; `LinkedChannelSummary` extended with `channel_source`, `channel_id`. All user-facing channel/group mentions use `format_chat_or_channel_display(title, username)` (utils). New-user /start fetches linked channel (profile + bio), appends configurable offer to protect that channel with "Защитить канал" button (setup guide URL, no bot link).
