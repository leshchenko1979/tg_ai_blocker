## Active Context

- **Current Focus**: Cloudflare AI Gateway Integration - Migrating all LLM operations from OpenRouter to Cloudflare AI Gateway for improved performance and cost efficiency.
- **Key Decisions**:
  - **Cloudflare Primary Provider**: All bot operations (spam classification, private chat) now use Cloudflare AI Gateway exclusively.
  - **OpenRouter Fallback Maintained**: Original OpenRouter functions preserved as fallback for potential future use.
  - **Environment Variable Architecture**: Clear separation with `API_BASE`/`CF_AIG_TOKEN` for Cloudflare, `OPENROUTER_API_BASE`/`OPENROUTER_API_KEY` for OpenRouter.
- **Recent Implementation**:
  - **Cloudflare AI Gateway Integration**: ✅ **Complete** - Added `get_cloudflare_response()` function with proper authentication and model configuration.
  - **Spam Classifier Migration**: ✅ **Complete** - Updated spam classification to use Cloudflare instead of OpenRouter.
  - **Private Chat Migration**: ✅ **Complete** - Updated private message handling to use Cloudflare for admin interactions.
  - **Environment Configuration**: ✅ **Complete** - Fixed environment variable confusion (restored OpenRouter URL, separated Cloudflare config).
  - **Code Cleanup**: ✅ **Complete** - Removed provider-specific references from generic functions, improved documentation clarity.
  - **LLM Provider Resilience**: ✅ **Complete** - Implemented optimized fallback strategy: Cloudflare (1 fast try) → OpenRouter (3 tries with model rotation). Cloudflare fails fast to avoid delays, OpenRouter handles retries and model fallbacks for maximum reliability.
- **Recent Implementation**:
  - **LLM Model Evaluation**: ✅ **Complete** - Comprehensive evaluation infrastructure with balanced test cases and JSON result storage.
  - **Memory Bank Documentation**: ✅ **Complete** - Updated systemPatterns.md to document Cloudflare AI Gateway usage.
  - **Logfire Trace Analysis**: ✅ **Complete** - Identified and fixed authentication issues in deployed code.
  - **Logfire Instrumentation Cleanup**: ✅ **Complete** - Implemented approved Logfire pattern: auto-tracing for modules with `@logfire.no_auto_trace` decorators on manually instrumented functions to prevent span duplication.
- **Immediate Next Steps**:
  - Monitor Cloudflare AI Gateway performance and stability.
  - Evaluate cost savings vs OpenRouter.
  - Consider removing OpenRouter functions if Cloudflare proves reliable long-term.