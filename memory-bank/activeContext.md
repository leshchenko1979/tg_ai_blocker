## Active Context

- **Current Focus**: MTProto optimization - removed inefficient numeric ID fallbacks.
- **Key Decisions**:
  - **MTProto Peer Resolution Optimization**: Eliminated numeric ID fallbacks in favor of username-only resolution (90%+ success rate vs 10% for numeric IDs).
  - **Stories Collection**: Modified `collect_user_stories` to require username, skip when unavailable.
  - **Linked Channel Collection**: Updated `collect_user_context` and `collect_channel_summary_by_id` to prioritize usernames over numeric IDs.
  - **Integration Test Updates**: Updated both spam classifier and channel extraction integration tests to use username-only resolution.
  - **Global Baseline Optimization**: Promoted 15 high-quality examples to common and deduplicated the entire common list (removed 14 redundant/low-value items).
  - **Spam Example Cleanup**: Reduced spam example counts for top two admins (85+ combined removals including common promotion).
  - **Test Classification Fixed**: Corrected classification of database tests as unit tests.
  - **Pytest Markers**: Implemented proper test markers (`@pytest.mark.integration`) to exclude flaky integration tests from deployment.
  - **Test Organization**: Moved standalone integration test scripts to dedicated `tests/integration/` directory.
  - **Deployment Safety**: Deployment now runs only reliable unit tests (83 tests) excluding external service dependencies.
  - **Private Message Prompt Cleaned**: Removed `/start` command content from private message reply prompt to avoid redundancy and focus on core conversation context.
- **Recent Implementation**:
  - **PRD Updated**: Synchronized `PRD.md` with current codebase and memory bank (added deep context analysis details, tech stack, and commands).
  - **Unit vs Integration Separation**: Database tests using local test databases are now correctly classified as unit tests.
  - **Pytest Configuration**: Updated `pytest.ini` with markers and default exclusion of integration tests.
  - **Test Structure**: Organized integration tests (Telegram API dependent) separately from unit tests.
  - **Prompt Optimization**: Streamlined private message system prompt by removing redundant `/start` command information.
  - **Landing Page Finalized**: Built professional Russian landing page with Tailwind CSS. Added **FAQ section** and **Final CTA** block to increase conversion. Optimized styling with custom utility classes and improved accessibility.
- **Immediate Next Steps**:
  - Monitor landing page deployment.
  - Monitor deployment reliability with improved test suite.
  - Consider adding more comprehensive integration test coverage for critical paths.

- **Testing Status**: ✅ **Testing Infrastructure Complete** - All 83 unit tests pass during deployment, integration tests properly excluded.
- **Previous Work Complete**: ✅ **Channel Content Analysis** - Successfully tested with real porn channel (@kotnikova_yana). Classifier now correctly identifies spam with 100% confidence by analyzing recent post content.
- **Prompt Optimization**: ✅ **Private Message Prompt Cleaned** - Removed redundant `/start` command content from LLM prompt for cleaner conversation context.
- **Edited Message Handling**: ✅ **Added Handler for Edited Messages** - Edited messages now return "edited_message_ignored" tag instead of generic "unhandled" for better Logfire observability. Handler does nothing else - edited messages are not moderated.